#!/bin/bash

# 1. Installation du binaire via Cargo
echo "üì¶ Installation du binaire..."
if ! command -v cargo &> /dev/null; then
    echo "‚ùå Cargo n'est pas install√©. Veuillez installer Rust."
    exit 1
fi
cargo install --path .

# 2. D√©tection du Shell et configuration de l'auto-compl√©tion
CURRENT_SHELL=$(basename "$SHELL")
echo "üêö Shell d√©tect√© : $CURRENT_SHELL"

case "$CURRENT_SHELL" in
    zsh)
        COMP_DIR="$HOME/.zsh/completions"
        RC_FILE="$HOME/.zshrc"

        mkdir -p "$COMP_DIR"
        # G√©n√®re le fichier de compl√©tion
        todo completion zsh > "$COMP_DIR/_todo"

        # V√©rifie si la configuration existe d√©j√† pour √©viter les doublons
        if ! grep -qF "fpath=($COMP_DIR \$fpath)" "$RC_FILE"; then
            echo "" >> "$RC_FILE"
            echo "# Todo completion" >> "$RC_FILE"
            echo "fpath=($COMP_DIR \$fpath)" >> "$RC_FILE"
            echo "autoload -Uz compinit && compinit" >> "$RC_FILE"
            echo "‚úÖ Configuration ajout√©e √† $RC_FILE"
        else
            echo "‚ÑπÔ∏è  Configuration Zsh d√©j√† pr√©sente."
        fi
        ;;

    bash)
        # Pour Bash, on source souvent directement ou on utilise bash_completion
        COMP_FILE="$HOME/.todo-completion.bash"
        RC_FILE="$HOME/.bashrc"

        # Sur macOS, c'est parfois .bash_profile
        if [[ "$OSTYPE" == "darwin"* && ! -f "$RC_FILE" ]]; then
            RC_FILE="$HOME/.bash_profile"
        fi

        todo completion bash > "$COMP_FILE"

        if ! grep -qF "source $COMP_FILE" "$RC_FILE"; then
            echo "" >> "$RC_FILE"
            echo "# Todo completion" >> "$RC_FILE"
            echo "source $COMP_FILE" >> "$RC_FILE"
            echo "‚úÖ Configuration ajout√©e √† $RC_FILE"
        fi
        ;;

    fish)
        COMP_DIR="$HOME/.config/fish/completions"
        mkdir -p "$COMP_DIR"
        todo completion fish > "$COMP_DIR/todo.fish"
        echo "‚úÖ Compl√©tions Fish install√©es dans $COMP_DIR"
        ;;

    *)
        echo "‚ö†Ô∏è  Shell non reconnu pour l'auto-configuration ($CURRENT_SHELL)."
        echo "   Veuillez ajouter manuellement l'auto-compl√©tion."
        ;;
esac

echo "üéâ Installation termin√©e ! Veuillez red√©marrer votre terminal ou ex√©cuter 'source $RC_FILE'"
